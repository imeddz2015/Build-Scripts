--- xts.c
+++ xts.c
@@ -49,15 +49,28 @@
 /* the algorithm reads this as a 128bit Little Endian number */
 /* src and dest can point to the same buffer for in-place operations */
 #if WORDS_BIGENDIAN
+
+#if (_LP64 || __LP64__)
 #define BE_SHIFT(x) ((((x) & 0x7f7f7f7f7f7f7f7f) << 1) | \
                      (((x) & 0x8080808080808080) >> 15))
+#else
+#define BE_SHIFT(x) ((((x) & 0x7f7f7f7f7f7f7f7full) << 1) | \
+                     (((x) & 0x8080808080808080ull) >> 15))
+#endif
+
 static void
 xts_shift(union nettle_block16 *dst,
           const union nettle_block16 *src)
 {
+#if (_LP64 || __LP64__)
   uint64_t carry = (src->u64[1] & 0x80) >> 7;
   dst->u64[1] = BE_SHIFT(src->u64[1]) | ((src->u64[0] & 0x80) << 49);
   dst->u64[0] = BE_SHIFT(src->u64[0]) ^ (0x8700000000000000 & -carry);
+#else
+  uint64_t carry = (src->u64[1] & 0x80) >> 7;
+  dst->u64[1] = BE_SHIFT(src->u64[1]) | ((src->u64[0] & 0x80) << 49);
+  dst->u64[0] = BE_SHIFT(src->u64[0]) ^ (0x8700000000000000ull & -carry);
+#endif
 }
 #else /* !WORDS_BIGENDIAN */
 static void
--- ctr.c
+++ ctr.c
@@ -48,6 +48,10 @@
 
 #define MIN(a,b) (((a) < (b)) ? (a) : (b))
 
+#if 1
+# undef HAVE_BUILTIN_BSWAP64
+#endif
+
 static size_t
 ctr_fill (size_t block_size, uint8_t *ctr, size_t length, uint8_t *buffer)
 {
--- run-tests
+++ run-tests
@@ -28,6 +28,13 @@
 
 export srcdir
 
+nettle_lib_dir=`dirname $PWD`/.lib
+LD_LIBRARY_PATH=$nettle_lib_dir
+DYLD_LIBRARY_PATH=$nettle_lib_dir
+
+export LD_LIBRARY_PATH
+export DYLD_LIBRARY_PATH
+
 # When used in make rules, we sometimes get the filenames VPATH
 # expanded, but usually not.
 find_program () {
--- testsuite/setup-env
+++ testsuite/setup-env
@@ -2,6 +2,13 @@
 
 set -e
 
+nettle_lib_dir=`dirname $PWD`/.lib
+LD_LIBRARY_PATH=$nettle_lib_dir
+DYLD_LIBRARY_PATH=$nettle_lib_dir
+
+export LD_LIBRARY_PATH
+export DYLD_LIBRARY_PATH
+
 # Workaround, it seems difficult to convince wine to put ../lib into PATH.
 case "$EMULATOR" in
     wine*)
--- testsuite/Makefile.in
+++ testsuite/Makefile.in
@@ -138,7 +138,6 @@
 
 # The PATH update is for windows dlls, DYLD_LIBRARY_PATH is for OSX.
 check: $(TS_ALL)
-	LD_LIBRARY_PATH=../.lib PATH="../.lib:$$PATH" DYLD_LIBRARY_PATH=../.lib \
 	  srcdir="$(srcdir)" \
 	  EMULATOR="$(EMULATOR)" NM="$(NM)" EXEEXT="$(EXEEXT)" \
           $(top_srcdir)/run-tests $(TS_ALL)
--- testsuite/nettle-pbkdf2-test
+++ testsuite/nettle-pbkdf2-test
@@ -4,6 +4,13 @@
   srcdir=`pwd`
 fi
 
+nettle_lib_dir=`dirname $PWD`/.lib
+LD_LIBRARY_PATH=$nettle_lib_dir
+DYLD_LIBRARY_PATH=$nettle_lib_dir
+
+export LD_LIBRARY_PATH
+export DYLD_LIBRARY_PATH
+
 test_pbkdf2 () {
     password="$1"
     salt="$2"
--- testsuite/sexp-conv-test
+++ testsuite/sexp-conv-test
@@ -4,6 +4,13 @@
   srcdir=`pwd`
 fi
 
+nettle_lib_dir=`dirname $PWD`/.lib
+LD_LIBRARY_PATH=$nettle_lib_dir
+DYLD_LIBRARY_PATH=$nettle_lib_dir
+
+export LD_LIBRARY_PATH
+export DYLD_LIBRARY_PATH
+
 print_raw () {
     printf "%s" "$1" > "$2"
 }
--- testsuite/pkcs1-conv-test
+++ testsuite/pkcs1-conv-test
@@ -4,6 +4,13 @@
   srcdir=`pwd`
 fi
 
+nettle_lib_dir=`dirname $PWD`/.lib
+LD_LIBRARY_PATH=$nettle_lib_dir
+DYLD_LIBRARY_PATH=$nettle_lib_dir
+
+export LD_LIBRARY_PATH
+export DYLD_LIBRARY_PATH
+
 [ -x ../tools/pkcs1-conv$EXEEXT ] || exit 77
 
 # Private RSA key, generated by openssl
--- testsuite/dlopen-test.c
+++ testsuite/dlopen-test.c
@@ -9,7 +9,11 @@
 main (int argc UNUSED, char **argv UNUSED)
 {
 #if HAVE_LIBDL
+#ifdef __APPLE__
+  void *handle = dlopen ("../libnettle.dylib", RTLD_NOW);
+#else
   void *handle = dlopen ("../libnettle.so", RTLD_NOW);
+#endif
   int (*get_version)(void);
   if (!handle)
     {
--- examples/setup-env
+++ examples/setup-env
@@ -2,6 +2,13 @@
 
 set -e
 
+nettle_lib_dir=`dirname $PWD`/.lib
+LD_LIBRARY_PATH=$nettle_lib_dir
+DYLD_LIBRARY_PATH=$nettle_lib_dir
+
+export LD_LIBRARY_PATH
+export DYLD_LIBRARY_PATH
+
 # Workaround, it seems difficult to convince wine to put ../lib into PATH.
 case "$EMULATOR" in
     wine*)
--- examples/Makefile.in
+++ examples/Makefile.in
@@ -115,7 +115,6 @@
 
 # The PATH update is for windows dlls, DYLD_LIBRARY_PATH is for OSX.
 check: $(TS_ALL)
-	LD_LIBRARY_PATH=../.lib PATH="../.lib:$$PATH" DYLD_LIBRARY_PATH=../.lib \
 	  srcdir="$(srcdir)" EMULATOR="$(EMULATOR)" EXEEXT="$(EXEEXT)" \
           "$(top_srcdir)"/run-tests $(TS_ALL)
 
--- examples/rsa-encrypt-test
+++ examples/rsa-encrypt-test
@@ -4,6 +4,13 @@
   srcdir=`pwd`
 fi
 
+nettle_lib_dir=`dirname $PWD`/.lib
+LD_LIBRARY_PATH=$nettle_lib_dir
+DYLD_LIBRARY_PATH=$nettle_lib_dir
+
+export LD_LIBRARY_PATH
+export DYLD_LIBRARY_PATH
+
 data="$srcdir/nettle-benchmark.c"
 
 if [ -x rsa-encrypt$EXEEXT ] ; then
--- examples/rsa-verify-test
+++ examples/rsa-verify-test
@@ -4,6 +4,13 @@
   srcdir=`pwd`
 fi
 
+nettle_lib_dir=`dirname $PWD`/.lib
+LD_LIBRARY_PATH=$nettle_lib_dir
+DYLD_LIBRARY_PATH=$nettle_lib_dir
+
+export LD_LIBRARY_PATH
+export DYLD_LIBRARY_PATH
+
 data="$srcdir/nettle-benchmark.c"
 
 if [ -x rsa-verify$EXEEXT ] ; then
--- examples/rsa-sign-test
+++ examples/rsa-sign-test
@@ -4,6 +4,13 @@
   srcdir=`pwd`
 fi
 
+nettle_lib_dir=`dirname $PWD`/.lib
+LD_LIBRARY_PATH=$nettle_lib_dir
+DYLD_LIBRARY_PATH=$nettle_lib_dir
+
+export LD_LIBRARY_PATH
+export DYLD_LIBRARY_PATH
+
 data="$srcdir/nettle-benchmark.c"
 
 if [ -x rsa-sign$EXEEXT ] ; then
